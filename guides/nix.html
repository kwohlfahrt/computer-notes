
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Nix &#8212; IT Notes 0.1 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Printers" href="printers.html" />
    <link rel="prev" title="Networking" href="networking.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="nix">
<span id="nix-guide"></span><h1>Nix<a class="headerlink" href="#nix" title="Permalink to this headline">¶</a></h1>
<p>The Nix package manager is a powerful tool for creating reproducible
environments to build software. NixOS is a Linux distribution based on this
package manager, but it can also be used on OSX, other Linux variants and the
experimental Genode operating system.</p>
<p>See the document on the <a class="reference internal" href="../programming/languages/nix/index.html#nix-language"><span class="std std-ref">Nix</span></a> language for language feature, this
document discusses use of the Nix package manager and conventions in the
canonical <cite>nixpkgs</cite> package set.</p>
<div class="section" id="patterns">
<h2>Patterns<a class="headerlink" href="#patterns" title="Permalink to this headline">¶</a></h2>
<p>The <cite>nixpkgs</cite> set uses several patterns to arrive at its final design.</p>
<div class="section" id="inputs">
<h3>Inputs<a class="headerlink" href="#inputs" title="Permalink to this headline">¶</a></h3>
<p>The first of these is the <cite>input</cite> design pattern, where a package is defined as
a function that takes all of its dependencies as inputs. This makes it easy to
replace a dependency, by simply calling the function with a different argument.</p>
<p>A sample package might look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>{ stdenv, libjpeg, jpegSupport ? true }:

stdenv.mkDerivation {
  name = &quot;hello-world&quot;;
  src = ./hello-world.tar.gz;
  buildInputs = if jpegSupport then [ libjpeg ] else [];
}
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">stdenv</span></code> argument contains useful, standard build tools (<code class="docutils literal notranslate"><span class="pre">gcc</span></code>,
<code class="docutils literal notranslate"><span class="pre">make</span></code>, etc) and some scripts which try to unpack and build projects with
common default options.</p>
<p>The other arguments are inputs needed at build-time or run-time, and it is all
tied together with the <code class="docutils literal notranslate"><span class="pre">mkDerivation</span></code> function.</p>
</div>
<div class="section" id="call-package">
<h3>Call-Package<a class="headerlink" href="#call-package" title="Permalink to this headline">¶</a></h3>
<p>The use of the <cite>input</cite> design pattern is made easier with the <cite>call-package</cite>
pattern. The <code class="docutils literal notranslate"><span class="pre">callPackageWith</span></code> function takes a base package set, a function
for a package and a set containing any additional arguments. The base package
set is used to give values to any function arguments not defined in the
additional arguments parameter, matching them by name. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">pkgs</span> <span class="o">=</span> <span class="p">{</span> <span class="n">foo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">bar</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">baz</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="p">}</span>
<span class="o">&gt;</span> <span class="n">fn</span> <span class="o">=</span> <span class="p">{</span> <span class="n">foo</span><span class="p">,</span> <span class="n">bar</span> <span class="p">}:</span> <span class="n">foo</span> <span class="o">+</span> <span class="n">bar</span>
<span class="o">&gt;</span> <span class="n">lib</span><span class="o">.</span><span class="n">callPackageWith</span> <span class="n">pkgs</span> <span class="n">fn</span> <span class="p">{}</span>
<span class="mi">3</span>
<span class="o">&gt;</span> <span class="n">lib</span><span class="o">.</span><span class="n">callPackageWith</span> <span class="n">pkgs</span> <span class="n">fn</span> <span class="p">{</span> <span class="n">bar</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="p">}</span>
<span class="mi">6</span>
</pre></div>
</div>
<p>As a convenience, the function argument may also be a path, which is imported
and treated as a function.</p>
<p>If the <a class="reference internal" href="#inputs">Inputs</a> example was in a file named <code class="docutils literal notranslate"><span class="pre">hello-world.nix</span></code>, we could do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">nixpkgs</span> <span class="o">=</span> <span class="kn">import</span> <span class="o">&lt;</span><span class="n">nixpkgs</span><span class="o">&gt;</span> <span class="p">{}</span>
<span class="o">&gt;</span> <span class="n">hello</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">callPackageWith</span> <span class="n">nixpkgs</span><span class="o">.</span><span class="n">pkgs</span> <span class="o">./</span><span class="n">hello</span><span class="o">-</span><span class="n">world</span><span class="o">.</span><span class="n">nix</span> <span class="p">{}</span>
</pre></div>
</div>
<p>But, if we wanted to build without JPEG support, we could just call it with
different arguments:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">lib</span><span class="o">.</span><span class="n">callPackageWith</span> <span class="n">nixpkgs</span><span class="o">.</span><span class="n">pkgs</span> <span class="o">./</span><span class="n">hello</span><span class="o">-</span><span class="n">world</span><span class="o">.</span><span class="n">nix</span> <span class="p">{</span> <span class="n">jpegSupport</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="overrides">
<h3>Overrides<a class="headerlink" href="#overrides" title="Permalink to this headline">¶</a></h3>
<p>Finally, the <cite>override</cite> design pattern allows us to replace function arguments
on an existing derivation, essentially re-calling the function with different
arguments. Imagine we had called the example derivation like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">hello</span><span class="o">-</span><span class="n">world</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">callPackageWith</span> <span class="n">nixpkgs</span><span class="o">.</span><span class="n">pkgs</span> <span class="o">./</span><span class="n">hello</span><span class="o">-</span><span class="n">world</span><span class="o">.</span><span class="n">nix</span> <span class="p">{}</span>
</pre></div>
</div>
<p>And now we wanted a copy that was otherwise identical, just without JPEG
support. <code class="docutils literal notranslate"><span class="pre">lib.callPackageWith</span></code> adds an <code class="docutils literal notranslate"><span class="pre">override</span></code> attribute that allows us
to do just that:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">hello</span><span class="o">-</span><span class="n">world</span><span class="o">.</span><span class="n">override</span> <span class="p">{</span> <span class="n">jpegSupport</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<p>The implementation can be found <code class="docutils literal notranslate"><span class="pre">&lt;nixpkgs/lib/customization&gt;</span></code>, and is fairly
simple.</p>
</div>
<div class="section" id="fix-point">
<h3>Fix-Point<a class="headerlink" href="#fix-point" title="Permalink to this headline">¶</a></h3>
<p>The <cite>fix-point</cite> system is a way of dynamically referencing variables in a set.
Normally, variables are resolved at declaration time. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">rec</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;abc&quot;</span><span class="p">;</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="s2">&quot;123&quot;</span><span class="p">;</span> <span class="p">}</span> <span class="o">//</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;xyz&quot;</span><span class="p">;</span> <span class="p">}</span>
<span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;xyz&quot;</span><span class="p">;</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;abc123&quot;</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<p>Even though <code class="docutils literal notranslate"><span class="pre">x</span></code> has been updated, <code class="docutils literal notranslate"><span class="pre">y</span></code> is unmodified. If we want <code class="docutils literal notranslate"><span class="pre">y</span></code> to
always be in sync with <code class="docutils literal notranslate"><span class="pre">x</span></code>, we can define a self-referential function as
follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">fix</span> <span class="o">=</span> <span class="n">fn</span><span class="p">:</span> <span class="n">let</span> <span class="n">fixpoint</span> <span class="o">=</span> <span class="n">fn</span> <span class="n">fixpoint</span><span class="p">;</span> <span class="ow">in</span> <span class="n">fixpoint</span>
<span class="o">&gt;</span> <span class="n">fix</span> <span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;abc&quot;</span><span class="p">;</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="s2">&quot;123&quot;</span><span class="p">;</span> <span class="p">})</span>
<span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;abc&quot;</span><span class="p">;</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;abc123&quot;</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<p>As we can see, <code class="docutils literal notranslate"><span class="pre">fix</span></code> on its own approximates the <code class="docutils literal notranslate"><span class="pre">rec</span></code> keyword. This works
because the field <code class="docutils literal notranslate"><span class="pre">x</span></code> does not reference itself or <code class="docutils literal notranslate"><span class="pre">y</span></code>, so the computation
eventually terminates without any further calls of the function.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">fixWithOverride</span></code> function allows us to replace values before the fix-point
is evaluated:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">fixWithOverride</span> <span class="o">=</span> <span class="n">fn</span><span class="p">:</span> <span class="n">overrides</span><span class="p">:</span> <span class="n">fix</span> <span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="p">(</span><span class="n">fn</span> <span class="bp">self</span><span class="p">)</span> <span class="o">//</span> <span class="n">overrides</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">fixWithOverride</span> <span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;xyz&quot;</span><span class="p">;</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="s2">&quot;123&quot;</span><span class="p">;</span> <span class="p">})</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;xyz&quot;</span><span class="p">;</span> <span class="p">}</span>
<span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;xyz&quot;</span><span class="p">;</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;xyz123&quot;</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<p>The value of <code class="docutils literal notranslate"><span class="pre">y</span></code> now represents the value of <code class="docutils literal notranslate"><span class="pre">x</span></code> when after the override was
applied.</p>
</div>
<div class="section" id="overlays">
<h3>Overlays<a class="headerlink" href="#overlays" title="Permalink to this headline">¶</a></h3>
<p>The nixpkgs set supports overlays using the fix-point system. Overlays can be
defined in <code class="docutils literal notranslate"><span class="pre">~/.config/nixpkgs/overlays</span></code>, or by adding <code class="docutils literal notranslate"><span class="pre">nixpkgs-overlays</span></code> to
<code class="docutils literal notranslate"><span class="pre">NIX_PATH</span></code>.</p>
<p>An overlay is a function of the form <code class="docutils literal notranslate"><span class="pre">self:</span> <span class="pre">super:</span> <span class="pre">{</span> <span class="pre">...</span> <span class="pre">}</span></code>. The second
argument, <code class="docutils literal notranslate"><span class="pre">super</span></code>, is the result of the composition before the current
overlay. The first argument is the fix-point of the result after all overlays
have been applied.</p>
<p><code class="docutils literal notranslate"><span class="pre">self</span></code> should only be used for attributes that are used to satisfy
dependencies, so that they take into account overrides in future overlays.
<code class="docutils literal notranslate"><span class="pre">super</span></code> should be used for other attributes, such as functions and attributes
which are overridden to avoid infinite recursion.</p>
<p>The design of overlays allows many of them to be chained, each one adding or
modifying the packages in the set.</p>
</div>
</div>
<div class="section" id="tools">
<h2>Tools<a class="headerlink" href="#tools" title="Permalink to this headline">¶</a></h2>
<p>The main tool used is known as <code class="docutils literal notranslate"><span class="pre">nix</span></code> <a class="reference internal" href="#nix-cmd" id="id1"><span>[nix-cmd]</span></a>. This has several subcommands,
which are described below.</p>
<div class="section" id="build">
<h3>Build<a class="headerlink" href="#build" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">nix</span> <span class="pre">build</span></code> builds the derivation given in a file.</p>
</div>
<div class="section" id="run">
<h3>Run<a class="headerlink" href="#run" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">nix</span> <span class="pre">run</span></code> opens a shell with a specified environment.</p>
<dl class="citation">
<dt class="label" id="nix-cmd"><span class="brackets"><a class="fn-backref" href="#id1">nix-cmd</a></span></dt>
<dd><p>The <code class="docutils literal notranslate"><span class="pre">nix</span></code> command mostly replaces older commands prefixed with
<code class="docutils literal notranslate"><span class="pre">nix-</span></code> (e.g. <code class="docutils literal notranslate"><span class="pre">nix</span> <span class="pre">build</span></code> replaces <code class="docutils literal notranslate"><span class="pre">nix-build</span></code>). However, some features
are not yet available in the new interface (e.g. <code class="docutils literal notranslate"><span class="pre">nix-shell</span></code>).</p>
</dd>
</dl>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">IT Notes</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ansible.html">Ansible</a></li>
<li class="toctree-l2"><a class="reference internal" href="btrfs.html">BTRFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="github.html">Github</a></li>
<li class="toctree-l2"><a class="reference internal" href="gpg.html">GnuPG</a></li>
<li class="toctree-l2"><a class="reference internal" href="kerberos.html">Kerberos</a></li>
<li class="toctree-l2"><a class="reference internal" href="networking.html">Networking</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Nix</a></li>
<li class="toctree-l2"><a class="reference internal" href="printers.html">Printers</a></li>
<li class="toctree-l2"><a class="reference internal" href="command-line/index.html">Command Line</a></li>
<li class="toctree-l2"><a class="reference internal" href="git/index.html">Git</a></li>
<li class="toctree-l2"><a class="reference internal" href="ldap/index.html">LDAP</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../programming/index.html">Programming</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Guides</a><ul>
      <li>Previous: <a href="networking.html" title="previous chapter">Networking</a></li>
      <li>Next: <a href="printers.html" title="next chapter">Printers</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Kai Wohlfahrt.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/guides/nix.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>